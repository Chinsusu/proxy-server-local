<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PGW Mapping Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css?v=1756567003">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="/">ðŸ”’ Proxy Gateway</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#pgwNav" aria-controls="pgwNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="pgwNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="/proxies">Proxies</a></li>
          <li class="nav-item"><a class="nav-link active" href="/manage">Mappings</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div id="alerts"></div>

    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Create Client-Proxy Mapping</h5>
      </div>
      <div class="card-body">
        <form id="form-mapping" class="row g-3 align-items-end">
          <div class="col-12 col-md-4">
            <label class="form-label">Client IP Address</label>
            <input type="text" name="client_ip" class="form-control" placeholder="192.168.1.100" required>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">Proxy Server</label>
            <select name="proxy_id" id="select-proxy" class="form-select" required>
              <option value="">Select proxy server...</option>
            </select>
          </div>
          <div class="col-12 col-md-4 d-grid d-md-block">
            <label class="form-label invisible">&nbsp;</label>
            <button type="submit" class="btn btn-primary">Create Mapping</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Bulk Create Mappings Card -->
    <div class="card mt-4">
      <div class="card-header">
        <h5 class="mb-0">Bulk Create Mappings</h5>
      </div>
      <div class="card-body">
        <form id="bulk-create-form">
          <div class="row mb-3">
            <div class="col-md-3">
              <label for="start-ip" class="form-label">Start IP</label>
              <input type="text" class="form-control" id="start-ip" value="192.168.2.101" required>
            </div>
            <div class="col-md-3">
              <label for="mapping-count-input" class="form-label">Number of Mappings</label>
              <input type="number" class="form-control" id="mapping-count-input" min="1" max="100" value="10" required>
            </div>
            <div class="col-md-3">
              <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" id="dry-run">
                <label class="form-check-label" for="dry-run">Dry Run</label>
              </div>
            </div>
            <div class="col-md-3">
              <div class="mt-4">
                <button type="submit" class="btn btn-success">Create Bulk Mappings</button>
              </div>
            </div>
          </div>
        </form>
        
        <!-- Progress Bar -->
        <div id="bulk-progress" class="mt-3" style="display: none;">
          <div class="progress mb-2">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
          </div>
          <div id="progress-text" class="small text-muted">Starting...</div>
        </div>
        
        <!-- Bulk Create Log -->
        <div id="bulk-log" class="mt-3" style="display: none;">
          <h6>Log:</h6>
          <div id="log-container" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Active Client Mappings</h5>
        <span class="text-muted" id="mapping-count">â€” mappings</span>
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle mb-0 mappings-table">
          <thead class="table-light">
            <tr>
              <th data-k="id" class="sortable">ID</th>
              <th data-k="client" class="sortable">Client IP/CIDR</th>
              <th data-k="proxy" class="sortable">Proxy Server</th>
              <th data-k="state" class="sortable">State</th>
              <th data-k="port" class="sortable">Local Port</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody-mappings">
            <tr>
              <td colspan="6" class="text-center">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Delete All Mappings Card -->
    <div class="card mt-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">Bulk Delete Operations</h6>
            <small class="text-muted">Delete all active client mappings</small>
          </div>
          <button id="btn-delete-all-mappings" class="btn btn-outline-danger">Delete All Mappings</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/app.js?v=1756567005"></script>

</body>
<script>
// Bulk Create Form Submit Handler
document.getElementById("bulk-create-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  const startIp = document.getElementById("start-ip").value;
  const count = parseInt(document.getElementById("mapping-count-input").value);
  const isDryRun = document.getElementById("dry-run").checked;
  
  await performBulkCreate(startIp, count, isDryRun);
});

// Bulk Create Function - SINGLE DEFINITION
async function performBulkCreate(startIp, count, isDryRun) {
  const progressContainer = document.getElementById("bulk-progress");
  const progressBar = document.getElementById("progress-bar");
  const progressText = document.getElementById("progress-text");
  const logContainer = document.getElementById("bulk-log");
  const logDiv = document.getElementById("log-container");
  
  progressContainer.style.display = "block";
  logContainer.style.display = "block";
  logDiv.innerHTML = "";
  
  function addLogEntry(message, type = "info") {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement("div");
    logEntry.className = type === "error" ? "text-danger" : (type === "success" ? "text-success" : "text-dark");
    logEntry.textContent = `[${timestamp}] ${message}`;
    logDiv.appendChild(logEntry);
    logDiv.scrollTop = logDiv.scrollHeight;
  }
  
  function updateProgress(current, total) {
    const percentage = Math.round((current / total) * 100);
    progressBar.style.width = percentage + "%";
    progressBar.textContent = percentage + "%";
    progressText.textContent = `Processing ${current} of ${total} mappings...`;
    
    if (current === total) {
      progressBar.classList.add("bg-success");
      progressText.textContent = "Completed!";
    }
  }
  
  addLogEntry(`Starting bulk create: ${count} mappings from ${startIp}${isDryRun ? " (DRY RUN)" : ""}`);
  
  try {
    // Fetch all required data
    addLogEntry("Fetching proxies, clients, and mappings...");
    const [proxiesResponse, clientsResponse, mappingsResponse] = await Promise.all([
      fetch("/api/v1/proxies"),
      fetch("/api/v1/clients"), 
      fetch("/api/v1/mappings")
    ]);
    
    if (!proxiesResponse.ok || !clientsResponse.ok || !mappingsResponse.ok) {
      throw new Error("Failed to fetch data from API");
    }
    
    const proxies = await proxiesResponse.json();
    const clients = await clientsResponse.json();
    const mappings = await mappingsResponse.json();
    
    // Find unmapped proxies
    const mappedProxyIds = new Set(mappings.map(m => m.proxy.id));
    const availableProxies = proxies.filter(p => 
      p.status === "OK" && 
      p.enabled && 
      !mappedProxyIds.has(p.id)
    );
    
    addLogEntry(`Total proxies: ${proxies.length}, OK status: ${proxies.filter(p => p.status === "OK" && p.enabled).length}, Available (unmapped): ${availableProxies.length}`);
    
    if (availableProxies.length === 0) {
      addLogEntry("No unmapped proxies available. All OK proxies are already in use.", "error");
      return;
    }
    
    const actualCount = Math.min(count, availableProxies.length);
    if (actualCount < count) {
      addLogEntry(`Adjusting to ${actualCount} mappings (limited by available proxies)`, "info");
    }
    
    // Process mappings
    const baseIpParts = startIp.split(".");
    let currentIp = parseInt(baseIpParts[3]);
    let processed = 0;
    let successCount = 0;
    
    for (let i = 0; i < actualCount; i++) {
      const clientIp = `${baseIpParts[0]}.${baseIpParts[1]}.${baseIpParts[2]}.${currentIp + i}`;
      const clientCidr = clientIp + "/32";
      const proxy = availableProxies[i];
      
      if (isDryRun) {
        addLogEntry(`[DRY RUN] Would create mapping for ${clientIp} -> ${proxy.host}:${proxy.port}`);
        processed++;
        updateProgress(processed, actualCount);
        await new Promise(resolve => setTimeout(resolve, 100));
        continue;
      }
      
      try {
        // Find or create client
        let client = clients.find(c => c.ip_cidr === clientCidr);
        
        if (!client) {
          const clientResponse = await fetch("/api/v1/clients", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ip_cidr: clientCidr, enabled: true })
          });
          
          if (clientResponse.ok) {
            client = await clientResponse.json();
            addLogEntry(`Created client for ${clientIp}`, "info");
          } else {
            const error = await clientResponse.text();
            addLogEntry(`âœ— Failed to create client for ${clientIp}: ${error}`, "error");
            processed++;
            updateProgress(processed, actualCount);
            continue;
          }
        }
        
        // Create mapping
        const mappingResponse = await fetch("/api/v1/mappings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ client_id: client.id, proxy_id: proxy.id })
        });
        
        if (mappingResponse.ok) {
          addLogEntry(`âœ“ Created mapping for ${clientIp} -> ${proxy.host}:${proxy.port}`, "success");
          successCount++;
        } else {
          const error = await mappingResponse.text();
          addLogEntry(`âœ— Failed to create mapping for ${clientIp}: ${error}`, "error");
        }
        
      } catch (err) {
        addLogEntry(`âœ— Error processing ${clientIp}: ${err.message}`, "error");
      }
      
      processed++;
      updateProgress(processed, actualCount);
      await new Promise(resolve => setTimeout(resolve, 200));
    }
    
    addLogEntry(`Completed: ${successCount}/${processed} mappings created successfully.`, "success");
    
    if (!isDryRun && successCount > 0) {
      setTimeout(() => location.reload(), 2000);
    }
  } catch (error) {
    addLogEntry(`Bulk create failed: ${error.message}`, "error");
  }
}

// Delete All Mappings Handler
document.getElementById("btn-delete-all-mappings").addEventListener("click", async function() {
  if (!confirm("Are you sure you want to delete ALL client mappings? This cannot be undone.")) {
    return;
  }
  
  this.disabled = true;
  this.textContent = "Deleting...";
  
  try {
    const response = await fetch("/api/v1/mappings");
    if (!response.ok) throw new Error("Failed to fetch mappings");
    
    const mappings = await response.json();
    let deleted = 0;
    
    for (const mapping of mappings) {
      try {
        const delResponse = await fetch(`/api/v1/mappings/${mapping.id}`, { method: "DELETE" });
        if (delResponse.ok) deleted++;
      } catch (err) {
        console.error("Error deleting mapping", mapping.id, err);
      }
    }
    
    alert(`Deleted ${deleted} of ${mappings.length} mappings`);
    location.reload();
  } catch (error) {
    alert("Error deleting mappings: " + error.message);
    this.disabled = false;
    this.textContent = "Delete All Mappings";
  }
});
</script>
</html>
